<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini Test (Ko‚Äòp savol, real-time, bitta silka)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
    --accent:#2563eb; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif; background:var(--bg); color:var(--text); min-height:100dvh; display:grid; place-items:center; padding:24px; }
  .wrap{ width:100%; max-width:1000px }
  header{ text-align:center; margin:0 0 20px; }
  header h1{ margin:0; font-size:clamp(22px,3.5vw,34px); }
  header p{ margin:6px 0 0; color:var(--muted); }
  .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid #eef2f7; padding:22px; }
  .grid{ display:grid; gap:18px; grid-template-columns:repeat(2,minmax(0,1fr)); }
  .choice{ display:flex; align-items:center; justify-content:center; gap:14px; padding:24px; cursor:pointer; border-radius:16px; border:1px solid #eef2f7; box-shadow:var(--shadow); background:#fff; min-height:130px; }
  .choice:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.1); }
  .emoji{ font-size:40px; } .title{ font-weight:800; font-size:clamp(18px,2.4vw,24px); }
  label{ display:block; font-weight:700; margin:10px 0 6px; }
  input[type="text"], textarea{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; outline:none; }
  textarea{ min-height:90px; resize:vertical; }
  .row{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end; }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 16px; border-radius:10px; border:1px solid transparent; background:var(--accent); color:#fff; font-weight:700; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease, background .15s ease; text-decoration:none; user-select:none; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(37,99,235,.25); }
  .btn.secondary{ background:#fff; color:var(--text); border-color:#e5e7eb }
  .btn.ghost{ background:transparent; border-color:#e5e7eb }
  .muted{ color:var(--muted); font-size:14px } .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }
  .section-title{ font-weight:800; margin:8px 0 12px }
  .list{ border:1px solid #eef2f7; border-radius:12px; overflow:hidden }
  .list .item{ display:grid; grid-template-columns:1fr auto auto; gap:10px; padding:10px 12px; border-top:1px solid #f1f5f9; align-items:center; }
  .list .item:first-child{ border-top:none }
  .badge{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#f8fafc }
  .pill{ padding:2px 8px; border-radius:999px; font-size:12px; background:#eef2ff; border:1px solid #e5e7eb; }
  .spacer{ height:10px }
  .row3{ display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:end; }
  .table{ width:100%; border-collapse:collapse; }
  .table th, .table td{ padding:8px 10px; border-bottom:1px solid #eef2f7; text-align:left; }
  @media (max-width:780px){
    .grid{ grid-template-columns:1fr; }
    .row3{ grid-template-columns:1fr; }
    .list .item{ grid-template-columns:1fr auto; }
  }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Mini Test ‚Äî real-time (ko‚Äòp savol)</h1>
    <p class="muted">Bitta sahifa. O‚Äòqituvchi ko‚Äòp savol qo‚Äòshadi, istaganini ‚Äúfaol‚Äù qilib belgilaydi. Talaba faqat faol savolni ko‚Äòradi.</p>
  </header>

  <!-- ROL + XONA KODI TANLASH -->
  <section id="screen-home" class="card">
    <div class="section-title">Rejim va Xona</div>
    <div class="row3">
      <div>
        <label>Xona kodi (masalan: A123 yoki 8457)</label>
        <input id="room-code" type="text" placeholder="Xona kodi" />
      </div>
      <div>
        <label>Ism (faqat talaba uchun)</label>
        <input id="student-name" type="text" placeholder="Familiya Ism" />
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" onclick="enterAs('teacher')">üë©‚Äçüè´ O‚Äòqituvchi</button>
        <button class="btn secondary" onclick="enterAs('student')">üéì Talaba</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="muted">Eslatma: O‚Äòqituvchi va Talaba <b>bir xil xona kodini</b> kiritishi kerak.</div>
  </section>

  <!-- O'QITUVCHI EKRANI -->
  <section id="screen-teacher" class="card" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
      <div class="section-title">O‚Äòqituvchi paneli (<span id="room-label-1"></span>)</div>
      <button class="btn ghost" onclick="goto('home')">‚Üê Orqaga</button>
    </div>

    <div class="muted">Savol va to‚Äòg‚Äòri javobni kiriting; qo‚Äòshilgach uni ‚ÄúFaol‚Äù qilib belgilashingiz mumkin (Talaba faqat faol savolni ko‚Äòradi).</div>

    <label>Savol</label>
    <textarea id="t-question" placeholder="Masalan: 5 + 2 = ?"></textarea>
    <div class="row">
      <div>
        <label>To‚Äòg‚Äòri javob</label>
        <input id="t-answer" type="text" placeholder="Masalan: 7">
      </div>
      <button class="btn" onclick="addQuestion()">Savolni qo‚Äòshish</button>
    </div>
    <div id="t-status" class="spacer"></div>

    <div class="spacer"></div>
    <div id="current-box" style="display:none; margin-top:10px">
      <div class="section-title">Faol (joriy) savol</div>
      <div class="card" style="padding:16px">
        <div id="current-q" style="font-weight:700"></div>
        <div id="current-a" class="muted"></div>
        <div id="current-time" class="muted"></div>
      </div>
    </div>

    <div class="spacer"></div>
    <div>
      <div class="section-title">Savollar ro‚Äòyxati</div>
      <div id="q-empty" class="muted">Hali savol qo‚Äòshilmagan.</div>
      <div id="q-list" class="list"></div>
    </div>

    <div class="spacer"></div>
    <div>
      <div class="section-title">Faol savolga yuborilgan javoblar</div>
      <div id="sub-empty" class="muted">Hozircha javob yo‚Äòq.</div>
      <div style="overflow:auto;">
        <table class="table">
          <thead><tr><th>Talaba</th><th>Vaqt</th><th>Holat</th><th>Javob</th></tr></thead>
          <tbody id="sub-list"></tbody>
        </table>
      </div>
      <div class="spacer"></div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn secondary" onclick="clearSubmissions()">Faol savol javoblarini tozalash</button>
        <button class="btn ghost" onclick="clearAllSubmissions()">Barcha javoblarni tozalash (xona)</button>
      </div>
    </div>
  </section>

  <!-- TALABA EKRANI -->
  <section id="screen-student" class="card" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
      <div class="section-title">Talaba paneli (<span id="room-label-2"></span>)</div>
      <button class="btn ghost" onclick="goto('home')">‚Üê Orqaga</button>
    </div>

    <div id="s-qbox" class="card" style="padding:16px; margin-bottom:12px">
      <div class="muted">Savol</div>
      <div id="s-question" style="font-weight:800; margin-top:6px">Faol savol hali tanlanmagan</div>
    </div>

    <label>Ism</label>
    <input id="s-name" type="text" placeholder="Familiya Ism">

    <label>Javob</label>
    <input id="s-answer" type="text" placeholder="Masalan: 7">

    <div class="spacer"></div>
    <button class="btn" onclick="submitAnswer()">Yuborish</button>
    <div id="s-status" class="spacer"></div>
  </section>
</div>

<!-- Firebase (compat) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  /* === 0) Firebase config ‚Äî sizniki === */
  const firebaseConfig = {
    apiKey: "AIzaSyBtNNAj2SMWZMI4kMOIxtWOE85GlJhJpDw",
    authDomain: "mini-test-e43d6.firebaseapp.com",
    projectId: "mini-test-e43d6",
    storageBucket: "mini-test-e43d6.firebasestorage.app",
    messagingSenderId: "280817680510",
    appId: "1:280817680510:web:7eb039abd3c8b06684d82f"
  };

  /* === 1) Init === */
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  /* === 2) Helpers === */
  const $ = (id) => document.getElementById(id);
  let ROOM = null, ROLE = null, ACTIVE_QID = null;
  let unsubRoom = null, unsubActiveQ = null, unsubSubs = null, unsubQList = null;

  function goto(screen){
    $('screen-home').style.display    = (screen === 'home')    ? '' : 'none';
    $('screen-teacher').style.display = (screen === 'teacher') ? '' : 'none';
    $('screen-student').style.display = (screen === 'student') ? '' : 'none';
  }

  async function enterAs(role){
    const room = $('room-code').value.trim();
    if(!room){ alert("Xona kodini kiriting"); return; }
    ROOM = room; ROLE = role;

    $('room-label-1').textContent = room;
    $('room-label-2').textContent = room;

    if(role === 'teacher'){
      goto('teacher'); attachRoomListeners(); attachQuestionsList();
    } else {
      const nameHome = $('student-name').value.trim();
      if(nameHome) $('s-name').value = nameHome;
      goto('student'); attachRoomListeners();
    }
  }

  /* === 3) Paths === */
  const roomDoc  = () => db.collection('rooms').doc(ROOM);
  const qCol     = () => roomDoc().collection('questions'); // savollar
  const subsCol  = () => roomDoc().collection('subs');      // javoblar

  /* === 4) Real-time: room va faol savol === */
  function attachRoomListeners(){
    if(unsubRoom) unsubRoom();
    unsubRoom = roomDoc().onSnapshot(snap => {
      const data = snap.data() || {};
      const newActive = data.activeQuestionId || null;
      // Faol savol o'zgarsa, tinglovchini qayta ulaymiz
      if (ACTIVE_QID !== newActive){
        ACTIVE_QID = newActive;
        attachActiveQuestionListener();
        attachSubmissionsListener();
      }
      // Talaba oynasidagi savol matni ‚Äî active listener ichida ham yangilanadi
      if(!ACTIVE_QID){
        $('s-question').textContent = 'Faol savol hali tanlanmagan';
        $('current-box').style.display = 'none';
      }
    });
  }

  function attachActiveQuestionListener(){
    if(unsubActiveQ) unsubActiveQ();
    if(!ACTIVE_QID){ return; }
    unsubActiveQ = qCol().doc(ACTIVE_QID).onSnapshot(doc => {
      const d = doc.data();
      if(!d){ $('s-question').textContent = 'Faol savol topilmadi'; $('current-box').style.display='none'; return; }
      // Talaba
      $('s-question').textContent = d.text || 'Savol matni yo‚Äòq';
      // O‚Äòqituvchi ‚Äî faol savol bloki
      $('current-box').style.display = '';
      $('current-q').textContent = d.text || '';
      $('current-a').textContent = 'To‚Äòg‚Äòri javob: ' + (d.answer ?? '');
      $('current-time').textContent = d.createdAt ? new Date(d.createdAt).toLocaleString() : '';
    });
  }

  /* === 5) Savollar ro'yxati (o'qituvchi) === */
  function attachQuestionsList(){
    if(unsubQList) unsubQList();
    unsubQList = qCol().orderBy('createdAt','desc').onSnapshot(snap => {
      const list = $('q-list'), empty = $('q-empty');
      list.innerHTML = '';
      if(snap.empty){ empty.style.display=''; return; }
      empty.style.display='none';
      snap.forEach(doc => {
        const d = doc.data(); const id = doc.id;
        const row = document.createElement('div'); row.className='item';
        const title = document.createElement('div');
        title.innerHTML = `<b>${d.text || '(savol)'}</b> <span class="muted">‚Äî javob: ${d.answer ?? ''}</span><br><span class="muted">${new Date(d.createdAt).toLocaleString()}</span>`;
        const activeBadge = document.createElement('div');
        activeBadge.innerHTML = (ACTIVE_QID === id) ? '<span class="pill">Faol</span>' : '';
        const actions = document.createElement('div');
        const btnSet = document.createElement('button');
        btnSet.className='btn secondary'; btnSet.textContent=(ACTIVE_QID===id?'Faol':'Faol qilish');
        btnSet.onclick = ()=> setActiveQuestion(id);
        const btnDel = document.createElement('button');
        btnDel.className='btn ghost'; btnDel.textContent='O‚Äòchirish';
        btnDel.onclick = ()=> deleteQuestion(id);
        actions.style.display='flex'; actions.style.gap='8px';
        actions.appendChild(btnSet); actions.appendChild(btnDel);
        row.appendChild(title); row.appendChild(activeBadge); row.appendChild(actions);
        list.appendChild(row);
      });
    });
  }

  async function addQuestion(){
    const q = $('t-question').value.trim();
    const a = $('t-answer').value.trim();
    if(!q || !a){ $('t-status').innerHTML = '<div class="err">Savol va javob bo‚Äòsh bo‚Äòlmasin.</div>'; return; }
    const docRef = await qCol().add({ text:q, answer:a, createdAt:Date.now() });
    // Qo‚Äòshilganini darrov faol qilmoqchi bo‚Äòlsangiz:
    await roomDoc().set({ activeQuestionId: docRef.id }, { merge:true });
    $('t-status').innerHTML = '<div class="ok">Savol qo‚Äòshildi va faol qilindi.</div>';
    $('t-question').value=''; $('t-answer').value='';
  }

  async function setActiveQuestion(qid){
    await roomDoc().set({ activeQuestionId: qid }, { merge:true });
  }

  async function deleteQuestion(qid){
    if(!confirm('Savol o‚Äòchirilsinmi?')) return;
    // Agar o‚Äòchirilayotgan savol faol bo‚Äòlsa ‚Äî faolni bo‚Äòshatib qo‚Äòyamiz
    if (ACTIVE_QID === qid){
      await roomDoc().set({ activeQuestionId: firebase.firestore.FieldValue.delete() }, { merge:true });
    }
    await qCol().doc(qid).delete();
  }

  /* === 6) Javoblar (faol savol bo‚Äòyicha) === */
  function attachSubmissionsListener(){
    if(unsubSubs) unsubSubs();
    const list = $('sub-list'), empty = $('sub-empty');
    list.innerHTML = ''; empty.style.display='';

    if(!ACTIVE_QID){ return; }

    unsubSubs = subsCol()
      .where('questionId','==',ACTIVE_QID)
      .onSnapshot(snap => {
        const rows = [];
        snap.forEach(doc => rows.push(doc.data()));
        // vaqt bo‚Äòyicha kamayma-ket ko‚Äòrsatamiz (klientda sort)
        rows.sort((a,b)=>(b.time||0)-(a.time||0));

        list.innerHTML='';
        if(rows.length===0){ empty.style.display=''; return; }
        empty.style.display='none';

        rows.forEach(s=>{
          const tr = document.createElement('tr');
          const td1 = document.createElement('td'); td1.textContent = s.name || '(ismi yo‚Äòq)';
          const td2 = document.createElement('td'); td2.className='muted'; td2.textContent = s.time ? new Date(s.time).toLocaleString() : '';
          const td3 = document.createElement('td'); td3.innerHTML = s.correct ? '<span class="badge ok">To‚Äòg‚Äòri</span>' : '<span class="badge err">Noto‚Äòg‚Äòri</span>';
          const td4 = document.createElement('td'); td4.textContent = s.answer ?? '';
          tr.appendChild(td1); tr.appendChild(td2); tr.appendChild(td3); tr.appendChild(td4);
          list.appendChild(tr);
        });
      });
  }

  async function clearSubmissions(){
    if(!ACTIVE_QID){ alert('Faol savol tanlanmagan.'); return; }
    const q = await subsCol().where('questionId','==',ACTIVE_QID).get();
    const batch = db.batch();
    q.forEach(d=>batch.delete(d.ref));
    await batch.commit();
  }

  async function clearAllSubmissions(){
    if(!confirm('Ushbu xonadagi BARCHA javoblar o‚Äòchirilsinmi?')) return;
    const q = await subsCol().get();
    const batch = db.batch();
    q.forEach(d=>batch.delete(d.ref));
    await batch.commit();
  }

  /* === 7) Talaba yuborishi === */
  async function submitAnswer(){
    const name = $('s-name').value.trim();
    const ans  = $('s-answer').value.trim();
    if(!name || !ans){ $('s-status').innerHTML = '<div class="err">Ism va javobni to‚Äòldiring.</div>'; return; }
    if(!ACTIVE_QID){ $('s-status').innerHTML = '<div class="warn">Faol savol tanlanmagan.</div>'; return; }

    // faol savolni o‚Äòqib to‚Äòg‚Äòriligini tekshiramiz
    const qSnap = await qCol().doc(ACTIVE_QID).get();
    const qd = qSnap.data();
    if(!qd){ $('s-status').innerHTML = '<div class="warn">Savol topilmadi.</div>'; return; }

    const correct = String(ans).trim().toLowerCase() === String(qd.answer ?? '').trim().toLowerCase();
    await subsCol().add({ name, answer:ans, correct, time:Date.now(), questionId:ACTIVE_QID });

    $('s-status').innerHTML = correct ? '<div class="ok">Javobingiz qabul qilindi. ‚úÖ</div>' : '<div class="warn">Javobingiz qabul qilindi.</div>';
    $('s-answer').value='';
  }

  /* start */
  goto('home');
</script>
</body>
</html>
