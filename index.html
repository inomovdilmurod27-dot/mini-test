<!DOCTYPE html>
<html lang="uz">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Mini Test (Real-time, bitta silka)</title>
<style>
  :root{
    --bg:#f6f7fb; --card:#ffffff; --text:#1f2937; --muted:#6b7280;
    --accent:#2563eb; --ok:#10b981; --warn:#f59e0b; --err:#ef4444;
    --radius:16px; --shadow:0 10px 24px rgba(0,0,0,.08);
  }
  *{box-sizing:border-box}
  body{ margin:0; font-family:system-ui, -apple-system, "Segoe UI", Roboto, Arial, sans-serif; background:var(--bg); color:var(--text); min-height:100dvh; display:grid; place-items:center; padding:24px; }
  .wrap{ width:100%; max-width:900px }
  header{ text-align:center; margin:0 0 20px; }
  header h1{ margin:0; font-size:clamp(22px,3.5vw,34px); }
  header p{ margin:6px 0 0; color:var(--muted); }
  .card{ background:var(--card); border-radius:var(--radius); box-shadow:var(--shadow); border:1px solid #eef2f7; padding:22px; }
  .grid{ display:grid; gap:18px; grid-template-columns:repeat(2, minmax(0,1fr)); }
  .choice{ display:flex; align-items:center; justify-content:center; gap:14px; padding:24px; cursor:pointer; border-radius:16px; border:1px solid #eef2f7; box-shadow:var(--shadow); background:#fff; min-height:130px; }
  .choice:hover{ transform:translateY(-2px); box-shadow:0 14px 28px rgba(0,0,0,.1); }
  .emoji{ font-size:40px; } .title{ font-weight:800; font-size:clamp(18px,2.4vw,24px); }
  label{ display:block; font-weight:700; margin:10px 0 6px; }
  input[type="text"], textarea{ width:100%; padding:12px 14px; border-radius:12px; border:1px solid #e5e7eb; outline:none; }
  textarea{ min-height:90px; resize:vertical; }
  .row{ display:grid; grid-template-columns:1fr auto; gap:10px; align-items:end; }
  .btn{ display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:12px 18px; border-radius:12px; border:1px solid transparent; background:var(--accent); color:#fff; font-weight:700; cursor:pointer; transition:transform .12s ease, box-shadow .12s ease, background .15s ease; text-decoration:none; user-select:none; }
  .btn:hover{ transform:translateY(-1px); box-shadow:0 8px 20px rgba(37,99,235,.25); }
  .btn.secondary{ background:#fff; color:var(--text); border-color:#e5e7eb }
  .btn.ghost{ background:transparent; border-color:#e5e7eb }
  .muted{ color:var(--muted); font-size:14px } .ok{ color:var(--ok) } .warn{ color:var(--warn) } .err{ color:var(--err) }
  .section-title{ font-weight:800; margin:8px 0 12px }
  .list{ border:1px solid #eef2f7; border-radius:12px; overflow:hidden }
  .list .item{ display:grid; grid-template-columns:1fr auto 120px; gap:10px; padding:10px 12px; border-top:1px solid #f1f5f9 }
  .list .item:first-child{ border-top:none }
  .badge{ padding:2px 8px; border-radius:999px; font-size:12px; border:1px solid #e5e7eb; background:#f8fafc }
  .spacer{ height:10px }
  .row2{ display:grid; grid-template-columns:1fr 1fr auto; gap:10px; align-items:end; }
  @media (max-width:720px){ .grid{ grid-template-columns:1fr } .list .item{ grid-template-columns:1fr auto 90px } .row2{ grid-template-columns:1fr; } }
</style>
</head>
<body>
<div class="wrap">
  <header>
    <h1>Mini Test ‚Äî real-time</h1>
    <p class="muted">Bitta sahifa, O‚Äòqituvchi & Talaba; turli qurilmalardan real-time ko‚Äòrinadi</p>
  </header>

  <!-- ROL + XONA KODI TANLASH -->
  <section id="screen-home" class="card">
    <div class="section-title">Rejim va Xona</div>
    <div class="row2">
      <div>
        <label>Xona kodi (masalan: A123 yoki 8457)</label>
        <input id="room-code" type="text" placeholder="Xona kodi" />
      </div>
      <div>
        <label>Ism (faqat talaba uchun)</label>
        <input id="student-name" type="text" placeholder="Familiya Ism" />
      </div>
      <div style="display:flex; gap:10px; flex-wrap:wrap">
        <button class="btn" onclick="enterAs('teacher')">üë©‚Äçüè´ O‚Äòqituvchi</button>
        <button class="btn secondary" onclick="enterAs('student')">üéì Talaba</button>
      </div>
    </div>
    <div class="spacer"></div>
    <div class="muted">Eslatma: O‚Äòqituvchi va Talaba **bir xil xona kodini** kiritishi kerak. Ma‚Äôlumotlar Firestore‚Äôda real-time sinxronlanadi.</div>
  </section>

  <!-- O'QITUVCHI EKRANI -->
  <section id="screen-teacher" class="card" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
      <div class="section-title">O‚Äòqituvchi paneli (<span id="room-label-1"></span>)</div>
      <button class="btn ghost" onclick="goto('home')">‚Üê Orqaga</button>
    </div>
    <div class="muted">Savol va to‚Äòg‚Äòri javobni kiriting; talabalarda darhol paydo bo‚Äòladi.</div>

    <label>Savol</label>
    <textarea id="t-question" placeholder="Masalan: 5 + 2 = ?"></textarea>
    <div class="row">
      <div>
        <label>To‚Äòg‚Äòri javob</label>
        <input id="t-answer" type="text" placeholder="Masalan: 7">
      </div>
      <button class="btn" onclick="saveQuestion()">Saqlash</button>
    </div>

    <div id="t-status" class="spacer"></div>

    <div id="current-box" style="display:none; margin-top:10px">
      <div class="section-title">Joriy savol</div>
      <div class="card" style="padding:16px">
        <div id="current-q" style="font-weight:700"></div>
        <div id="current-a" class="muted"></div>
        <div id="current-time" class="muted"></div>
      </div>
    </div>

    <div class="spacer"></div>

    <div style="display:flex; gap:10px; flex-wrap:wrap">
      <button class="btn secondary" onclick="clearQuestion()">Savolni o‚Äòchirish</button>
      <button class="btn secondary" onclick="clearSubmissions()">Javoblarni tozalash</button>
    </div>

    <div class="spacer"></div>

    <div>
      <div class="section-title">Yuborilgan javoblar</div>
      <div id="sub-list" class="list"></div>
      <div id="sub-empty" class="muted">Hozircha javob yo‚Äòq.</div>
    </div>
  </section>

  <!-- TALABA EKRANI -->
  <section id="screen-student" class="card" style="display:none">
    <div style="display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:10px">
      <div class="section-title">Talaba paneli (<span id="room-label-2"></span>)</div>
      <button class="btn ghost" onclick="goto('home')">‚Üê Orqaga</button>
    </div>

    <div id="s-qbox" class="card" style="padding:16px; margin-bottom:12px">
      <div class="muted">Savol</div>
      <div id="s-question" style="font-weight:800; margin-top:6px">Savol hali kiritilmagan</div>
    </div>

    <label>Ism</label>
    <input id="s-name" type="text" placeholder="Familiya Ism">

    <label>Javob</label>
    <input id="s-answer" type="text" placeholder="Masalan: 7">

    <div class="spacer"></div>
    <button class="btn" onclick="submitAnswer()">Yuborish</button>
    <div id="s-status" class="spacer"></div>
  </section>
</div>

<!-- Firebase v9 (compat yoki modular) ‚Äî bu yerda compat ishlatyapmiz sodda bo'lgani uchun -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script>
  // === 0) Firebase sozlamalari (O'zingizning project config'ingizni kiriting) ===
  // Firebase Console ‚Üí Project settings ‚Üí Your apps ‚Üí SDK setup and configuration
  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "YOUR_AUTH_DOMAIN",
    projectId: "YOUR_PROJECT_ID",
    storageBucket: "YOUR_STORAGE_BUCKET",
    messagingSenderId: "YOUR_SENDER_ID",
    appId: "YOUR_APP_ID"
  };

  // === 1) Init ===
  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  // === 2) Utility ===
  const $ = (id) => document.getElementById(id);
  let ROOM = null;
  let ROLE = null;
  let unsubRoom = null;
  let unsubSubs = null;

  function goto(screen){
    $('screen-home').style.display    = (screen === 'home')    ? '' : 'none';
    $('screen-teacher').style.display = (screen === 'teacher') ? '' : 'none';
    $('screen-student').style.display = (screen === 'student') ? '' : 'none';
  }

  async function enterAs(role){
    const room = $('room-code').value.trim();
    if(!room){ alert("Xona kodini kiriting"); return; }

    ROOM = room;
    ROLE = role;

    $('room-label-1').textContent = room;
    $('room-label-2').textContent = room;

    if(role === 'teacher'){
      goto('teacher');
      attachRoomListeners();
    } else {
      // student
      const nameHome = $('student-name').value.trim();
      if(nameHome) $('s-name').value = nameHome;
      goto('student');
      attachRoomListeners();
    }
  }

  // === 3) Firestore path'lar ===
  function roomDoc(){ return db.collection('rooms').doc(ROOM); }
  function subsCol(){ return roomDoc().collection('subs'); }

  // === 4) Real-time listeners ===
  function attachRoomListeners(){
    // Joriy savol (doc listener)
    if(unsubRoom) unsubRoom();
    unsubRoom = roomDoc().onSnapshot(snap => {
      const data = snap.data();
      // Teacher UI
      if(ROLE === 'teacher'){
        if(data && data.question){
          $('current-box').style.display = '';
          $('current-q').textContent = data.question;
          $('current-a').textContent = 'To‚Äòg‚Äòri javob: ' + (data.answer ?? '');
          $('current-time').textContent = data.createdAt ? new Date(data.createdAt).toLocaleString() : '';
        } else {
          $('current-box').style.display = 'none';
        }
      }
      // Student UI
      $('s-question').textContent = (data && data.question) ? data.question : 'Savol hali kiritilmagan';
    });

    // Yuborilgan javoblar (collection listener) ‚Äî faqat o‚Äòqituvchi ekranida ko‚Äòrsatamiz
    if(unsubSubs) unsubSubs();
    unsubSubs = subsCol().orderBy('time','desc').onSnapshot(snap => {
      if(ROLE !== 'teacher') return;
      const list = $('sub-list');
      const empty = $('sub-empty');
      list.innerHTML = '';
      if(snap.empty){ empty.style.display = ''; return; }
      empty.style.display = 'none';
      snap.forEach(doc => {
        const s = doc.data();
        const row = document.createElement('div');
        row.className = 'item';
        const name = document.createElement('div');
        name.textContent = s.name || '(ismi yo‚Äòq)';
        const when = document.createElement('div');
        when.className = 'muted';
        when.textContent = s.time ? new Date(s.time).toLocaleString() : '';
        const res = document.createElement('div');
        res.className = 'badge ' + (s.correct ? 'ok' : 'err');
        res.textContent = s.correct ? 'To‚Äòg‚Äòri' : 'Noto‚Äòg‚Äòri';
        row.appendChild(name); row.appendChild(when); row.appendChild(res);
        list.appendChild(row);
      });
    });
  }

  // === 5) O‚Äòqituvchi amallari ===
  async function saveQuestion(){
    const q = $('t-question').value.trim();
    const a = $('t-answer').value.trim();
    if(!q || !a){ $('t-status').innerHTML = '<div class="err">Savol va javob bo‚Äòsh bo‚Äòlmasin.</div>'; return; }

    await roomDoc().set({
      question: q, answer: a, createdAt: Date.now()
    }, { merge: true });

    $('t-status').innerHTML = '<div class="ok">Saqlandi.</div>';
  }

  async function clearQuestion(){
    await roomDoc().set({ question: firebase.firestore.FieldValue.delete(), answer: firebase.firestore.FieldValue.delete(), createdAt: Date.now() }, { merge: true });
  }

  async function clearSubmissions(){
    const snap = await subsCol().get();
    const batch = db.batch();
    snap.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
  }

  // === 6) Talaba amallari ===
  async function submitAnswer(){
    const name = $('s-name').value.trim();
    const ans  = $('s-answer').value.trim();
    if(!name || !ans){ $('s-status').innerHTML = '<div class="err">Ism va javobni to‚Äòldiring.</div>'; return; }

    const docSnap = await roomDoc().get();
    const data = docSnap.data();
    if(!data || !data.question){ $('s-status').innerHTML = '<div class="warn">Hozircha savol mavjud emas.</div>'; return; }

    const correct = String(ans).trim().toLowerCase() === String(data.answer ?? '').trim().toLowerCase();
    await subsCol().add({ name, answer: ans, correct, time: Date.now() });

    $('s-status').innerHTML = correct ? '<div class="ok">Javobingiz qabul qilindi. ‚úÖ</div>' : '<div class="warn">Javobingiz qabul qilindi.</div>';
    $('s-answer').value = '';
  }

  // start
  goto('home');
</script>
  <script type="module">
  // Import the functions you need from the SDKs you need
  import { initializeApp } from "https://www.gstatic.com/firebasejs/12.6.0/firebase-app.js";
  // TODO: Add SDKs for Firebase products that you want to use
  // https://firebase.google.com/docs/web/setup#available-libraries

  // Your web app's Firebase configuration
  const firebaseConfig = {
    apiKey: "AIzaSyBtNNAj2SMWZMI4kMOIxtWOE85GlJhJpDw",
    authDomain: "mini-test-e43d6.firebaseapp.com",
    projectId: "mini-test-e43d6",
    storageBucket: "mini-test-e43d6.firebasestorage.app",
    messagingSenderId: "280817680510",
    appId: "1:280817680510:web:7eb039abd3c8b06684d82f"
  };

  // Initialize Firebase
  const app = initializeApp(firebaseConfig);
</script>
</body>
</html>
